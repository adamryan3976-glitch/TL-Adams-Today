<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Library Daily</title>
    
    <!-- React & Babel for in-browser execution -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simple SVG versions of Lucide icons to avoid dependency issues
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const RefreshIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>;
        const BookIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const StarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;

        const App = () => {
            const [scheduleData, setScheduleData] = useState([]);
            const [metaData, setMetaData] = useState({ weekday: '', date: '', cycle: '', events: '' });
            const [loading, setLoading] = useState(true);
            const [lastUpdated, setLastUpdated] = useState('');
            const [error, setError] = useState(null);

            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkqCHaCLV6PfsN2ifecQUscJEdqsyvJU6w2i1nZpovSSJjfN4qH0C-7kIAh48uJEWIxuFJTFjTlr7c/pub?gid=1873441959&single=true&output=csv';

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const text = await response.text();
                    
                    const rows = text.split('\n').map(row => {
                        return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/"/g, '').trim());
                    });

                    // 1. Meta Data (Rows 2-5)
                    setMetaData({
                        weekday: rows[1]?.[2] || '',
                        date: rows[2]?.[2] || '',
                        cycle: rows[3]?.[2] || '',
                        events: rows[4]?.[2] || ''
                    });

                    // 2. Schedule Pairs (Rows 6-35)
                    const pairs = [];
                    for (let i = 5; i < 35; i += 2) {
                        if (rows[i] && rows[i+1]) {
                            pairs.push({
                                periodName: rows[i][0],
                                roomBooking: rows[i][2],
                                timeRange: rows[i+1][0],
                                adamsLocation: rows[i+1][2]
                            });
                        }
                    }

                    setScheduleData(pairs);
                    setLastUpdated(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    setError(null);
                } catch (err) {
                    setError("Sync Error: Swipe down to try again.");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 300000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="min-h-screen pb-24">
                    {/* Header */}
                    <div className="sticky top-0 z-20 bg-white/90 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex flex-col">
                            <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1">
                                {metaData.cycle || 'FETCHING...'}
                            </span>
                            <h1 className="text-xl font-bold text-slate-800 leading-none">
                                {metaData.weekday || 'Today'} <span className="text-slate-400 font-medium text-sm">| {metaData.date}</span>
                            </h1>
                        </div>
                        <button 
                            onClick={fetchData}
                            className={`p-2 rounded-full active:bg-slate-100 transition-colors ${loading ? 'text-blue-500' : 'text-slate-400'}`}
                        >
                            <RefreshIcon className={loading ? 'animate-spin' : ''} />
                        </button>
                    </div>

                    {/* Events Banner */}
                    {metaData.events && metaData.events.toLowerCase() !== "none" && (
                        <div className="mx-4 mt-4 p-4 bg-amber-50 border border-amber-100 rounded-2xl flex gap-3 items-start">
                            <div className="text-amber-500 shrink-0 mt-0.5"><StarIcon /></div>
                            <div>
                                <h2 className="text-[10px] font-black text-amber-600 uppercase tracking-wider mb-1">Today's Events</h2>
                                <p className="text-sm text-amber-900 font-bold leading-snug">{metaData.events}</p>
                            </div>
                        </div>
                    )}

                    {/* Cards */}
                    <main className="p-4 space-y-4">
                        {scheduleData.map((slot, index) => {
                            const isAvailable = !slot.roomBooking || slot.roomBooking.toLowerCase().includes('available');
                            return (
                                <div key={index} className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="px-5 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                        <span className="text-xs font-black text-slate-500 uppercase tracking-wider">{slot.periodName}</span>
                                        <div className="flex items-center gap-1.5 text-slate-400 font-bold text-[11px]">
                                            <ClockIcon />
                                            {slot.timeRange}
                                        </div>
                                    </div>
                                    
                                    <div className="p-5 space-y-5">
                                        <div className="flex gap-4 items-start">
                                            <div className={`w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 ${!isAvailable ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-300'}`}>
                                                <BookIcon />
                                            </div>
                                            <div>
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Teaching Space</span>
                                                <p className={`text-base font-bold leading-tight ${!isAvailable ? 'text-slate-800' : 'text-slate-300 italic'}`}>
                                                    {slot.roomBooking || 'Available'}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="flex gap-4 items-start">
                                            <div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center shrink-0">
                                                <UserIcon />
                                            </div>
                                            <div>
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Where's Adams?</span>
                                                <p className="text-base font-bold text-slate-800 leading-tight">
                                                    {slot.adamsLocation || 'Unknown'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </main>

                    {error && <div className="mx-6 p-4 bg-red-50 text-red-600 rounded-2xl text-xs font-bold text-center border border-red-100">{error}</div>}
                    
                    <footer className="px-6 py-6 text-center opacity-30">
                        <p className="text-[10px] font-black uppercase tracking-[0.3em]">Updated {lastUpdated}</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
