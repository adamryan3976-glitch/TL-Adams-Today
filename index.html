<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA / iOS Home Screen Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lib Daily">
    
    <!-- Icon & Favicon (Assumes image is named knight.png in the same folder) -->
    <link rel="apple-touch-icon" href="knight.png">
    <link rel="icon" type="image/png" href="knight.png">
    
    <title>Library Daily</title>
    
    <!-- React & Babel for in-browser execution -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS with Custom Knight Theme Colors -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        knightBlue: '#1e6eb0', 
                        knightGold: '#e9c693', 
                        knightDark: '#2c3e50',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .parchment-bg {
            background-color: #fdf8f0;
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Assets
        const LOGO_URL = "https://drive.google.com/uc?export=view&id=1j1coC0A1BZ4eAoGOGCNptTKKqXxQInn0";
        const BOOKING_FORM_URL = "https://forms.gle/VZUvq7CzJb3bu3gJA";

        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const RefreshIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>;
        const BookIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const StarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const ExternalLinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>;

        const App = () => {
            const [scheduleData, setScheduleData] = useState([]);
            const [metaData, setMetaData] = useState({ weekday: '', date: '', cycle: '', events: '' });
            const [loading, setLoading] = useState(true);
            const [lastUpdated, setLastUpdated] = useState('');
            const [error, setError] = useState(null);

            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSkqCHaCLV6PfsN2ifecQUscJEdqsyvJU6w2i1nZpovSSJjfN4qH0C-7kIAh48uJEWIxuFJTFjTlr7c/pub?gid=1873441959&single=true&output=csv';

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const text = await response.text();
                    
                    const rows = text.split('\n').map(row => {
                        return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/"/g, '').trim());
                    });

                    setMetaData({
                        weekday: rows[1]?.[2] || '',
                        date: rows[2]?.[2] || '',
                        cycle: rows[3]?.[2] || '',
                        events: rows[4]?.[2] || ''
                    });

                    const pairs = [];
                    for (let i = 5; i < 35; i += 2) {
                        if (rows[i] && rows[i+1]) {
                            pairs.push({
                                periodName: rows[i][0],
                                roomBooking: rows[i][2],
                                timeRange: rows[i+1][0],
                                adamsLocation: rows[i+1][2]
                            });
                        }
                    }

                    setScheduleData(pairs);
                    setLastUpdated(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    setError(null);
                } catch (err) {
                    setError("Sync Error: Swipe down or tap refresh.");
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 300000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="min-h-screen pb-32 parchment-bg">
                    {/* Header */}
                    <div className="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b-2 border-knightGold px-6 py-4 flex justify-between items-center shadow-md">
                        <div className="flex items-center gap-3">
                            <img 
                                src={LOGO_URL} 
                                alt="Winchester Logo" 
                                className="w-10 h-10 object-contain" 
                                onError={(e) => {
                                    // Fallback to local if drive link fails
                                    if(e.target.src !== 'knight.png') e.target.src = 'knight.png';
                                }} 
                            />
                            <div className="flex flex-col">
                                <span className="text-[10px] font-black text-knightBlue uppercase tracking-widest leading-none mb-1">
                                    {metaData.cycle || 'FETCHING...'}
                                </span>
                                <h1 className="text-xl font-bold text-slate-800 leading-none">
                                    {metaData.weekday || 'Today'} <span className="text-slate-400 font-medium text-sm">| {metaData.date}</span>
                                </h1>
                            </div>
                        </div>
                        <button 
                            onClick={fetchData}
                            className={`p-2 rounded-full active:bg-slate-100 transition-colors ${loading ? 'text-knightBlue' : 'text-slate-400'}`}
                        >
                            <RefreshIcon className={loading ? 'animate-spin' : ''} />
                        </button>
                    </div>

                    {/* Events Banner */}
                    {metaData.events && metaData.events.toLowerCase() !== "none" && (
                        <div className="mx-4 mt-4 p-4 bg-white border-l-4 border-knightBlue rounded-r-2xl shadow-sm flex gap-3 items-start">
                            <div className="text-knightBlue shrink-0 mt-0.5"><StarIcon /></div>
                            <div>
                                <h2 className="text-[10px] font-black text-knightBlue uppercase tracking-wider mb-1">Today's Events</h2>
                                <p className="text-sm text-slate-800 font-bold leading-snug">{metaData.events}</p>
                            </div>
                        </div>
                    )}

                    {/* Cards */}
                    <main className="p-4 space-y-4">
                        {scheduleData.map((slot, index) => {
                            const isAvailable = !slot.roomBooking || slot.roomBooking.toLowerCase().includes('available');
                            return (
                                <div key={index} className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="px-5 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                                        <span className="text-xs font-black text-knightBlue uppercase tracking-wider">{slot.periodName}</span>
                                        <div className="flex items-center gap-1.5 text-slate-400 font-bold text-[11px]">
                                            <ClockIcon />
                                            {slot.timeRange}
                                        </div>
                                    </div>
                                    
                                    <div className="p-5 space-y-5">
                                        <div className="flex gap-4 items-start">
                                            <div className={`w-10 h-10 rounded-2xl flex items-center justify-center shrink-0 ${!isAvailable ? 'bg-blue-50 text-knightBlue' : 'bg-slate-100 text-slate-300'}`}>
                                                <BookIcon />
                                            </div>
                                            <div>
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Teaching Space</span>
                                                <p className={`text-base font-bold leading-tight ${!isAvailable ? 'text-slate-800' : 'text-slate-300 italic'}`}>
                                                    {slot.roomBooking || 'Available'}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="flex gap-4 items-start">
                                            <div className="w-10 h-10 bg-orange-50 text-amber-700 rounded-2xl flex items-center justify-center shrink-0">
                                                <UserIcon />
                                            </div>
                                            <div>
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Where's Adams?</span>
                                                <p className="text-base font-bold text-slate-800 leading-tight">
                                                    {slot.adamsLocation || 'Unknown'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </main>

                    {error && <div className="mx-6 p-4 bg-red-50 text-red-600 rounded-2xl text-xs font-bold text-center border border-red-100">{error}</div>}
                    
                    <footer className="px-6 py-8 text-center flex flex-col items-center gap-4">
                        <img 
                            src={LOGO_URL} 
                            alt="Logo" 
                            className="w-12 h-12 opacity-20 grayscale" 
                            onError={(e) => { if(e.target.src !== 'knight.png') e.target.src = 'knight.png'; }}
                        />
                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">Updated {lastUpdated}</p>
                    </footer>

                    {/* Fixed Action Button */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent safe-bottom">
                        <a 
                            href={BOOKING_FORM_URL}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="w-full bg-knightBlue text-white py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3 font-bold text-lg active:scale-[0.98] transition-all"
                        >
                            <BookIcon />
                            <span>Book The Library</span>
                            <ExternalLinkIcon />
                        </a>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
